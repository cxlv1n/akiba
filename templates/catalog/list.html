{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Каталог — AkibaAuto{% endblock %}

{% block content %}
<section class="popular" id="catalog">
    <div class="container">
        <h1 class="popular__title">Каталог автомобилей</h1>
        <div class="popular__box">
            <div class="popular__filters">
                <div class="filter-controls">
                    <button type="button" class="filter-toggle-btn" id="filterToggleBtn" aria-expanded="false">
                        <span class="filter-toggle-btn__text">Фильтры</span>
                        <svg class="filter-toggle-btn__icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>

                    <div class="sort-dropdown">
                        <button type="button" class="sort-toggle-btn" id="sortToggleBtn">
                            <span class="sort-toggle-btn__text">
                                {% if selected_sort == "price_asc" %}Цена: по возрастанию
                                {% elif selected_sort == "price_desc" %}Цена: по убыванию
                                {% elif selected_sort == "year_desc" %}Год: новее
                                {% elif selected_sort == "year_asc" %}Год: старше
                                {% elif selected_sort == "mileage_asc" %}Пробег: меньше
                                {% elif selected_sort == "mileage_desc" %}Пробег: больше
                                {% else %}Сортировка{% endif %}
                            </span>
                            <svg class="sort-toggle-btn__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div class="sort-dropdown-menu" id="sortDropdownMenu">
                            <button type="button" class="sort-option" data-sort="">
                                <span class="sort-option__text">По умолчанию</span>
                                {% if not selected_sort %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                            <button type="button" class="sort-option" data-sort="price_asc">
                                <span class="sort-option__text">Цена: по возрастанию</span>
                                {% if selected_sort == "price_asc" %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                            <button type="button" class="sort-option" data-sort="price_desc">
                                <span class="sort-option__text">Цена: по убыванию</span>
                                {% if selected_sort == "price_desc" %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                            <button type="button" class="sort-option" data-sort="year_desc">
                                <span class="sort-option__text">Год: новее</span>
                                {% if selected_sort == "year_desc" %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                            <button type="button" class="sort-option" data-sort="year_asc">
                                <span class="sort-option__text">Год: старше</span>
                                {% if selected_sort == "year_asc" %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                            <button type="button" class="sort-option" data-sort="mileage_asc">
                                <span class="sort-option__text">Пробег: меньше</span>
                                {% if selected_sort == "mileage_asc" %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                            <button type="button" class="sort-option" data-sort="mileage_desc">
                                <span class="sort-option__text">Пробег: больше</span>
                                {% if selected_sort == "mileage_desc" %}<span class="sort-option__check">✓</span>{% endif %}
                            </button>
                        </div>
                    </div>

                    {% if selected_origin or selected_manufacturer or selected_model or selected_fuel or selected_body_type or selected_drive or selected_mileage_from or selected_mileage_to or selected_price_from or selected_price_to or selected_engine_volume_from or selected_engine_volume_to or selected_year_from or selected_year_to or selected_sort %}
                        <a href="{% url 'catalog:list' %}" class="btn btn--secondary filter-reset-btn">Сбросить</a>
                    {% endif %}
                </div>
                <form method="get" action="{% url 'catalog:list' %}" class="popular__filters-form" id="filterForm">
                    <div class="popular__filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Авто из:</label>
                            <select name="origin" class="filter-select" id="originSelect">
                                <option value="">Все</option>
                                <option value="CN" {% if selected_origin == "CN" %}selected{% endif %}>Китай</option>
                                <option value="JP" {% if selected_origin == "JP" %}selected{% endif %}>Япония</option>
                                <option value="KR" {% if selected_origin == "KR" %}selected{% endif %}>Корея</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Марка автомобиля</label>
                            <select name="manufacturer" class="filter-select" id="manufacturerSelect">
                                <option value="">Все марки</option>
                                {% for m in manufacturers %}
                                    <option value="{{ m }}" {% if selected_manufacturer == m %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Двигатель</label>
                            <select name="fuel" class="filter-select" id="fuelSelect">
                                <option value="">Все</option>
                                {% for f in fuels %}
                                    <option value="{{ f }}" {% if selected_fuel == f %}selected{% endif %}>{{ f }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Кузов</label>
                            <select name="body_type" class="filter-select" id="bodyTypeSelect">
                                <option value="">Все</option>
                                {% for bt in body_types %}
                                    <option value="{{ bt }}" {% if selected_body_type == bt %}selected{% endif %}>{{ bt }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Привод</label>
                            <select name="drive" class="filter-select" id="driveSelect">
                                <option value="">Все</option>
                                {% for d in drives %}
                                    <option value="{{ d }}" {% if selected_drive == d %}selected{% endif %}>{{ d }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-group filter-group--range">
                            <label class="filter-label">Пробег, км</label>
                            <div class="filter-range">
                                <input type="number" name="mileage_from" class="filter-input" id="mileageFrom"
                                       value="{{ selected_mileage_from }}" placeholder="от" min="0">
                                <span class="filter-range__divider">—</span>
                                <input type="number" name="mileage_to" class="filter-input" id="mileageTo"
                                       value="{{ selected_mileage_to }}" placeholder="до" min="0">
                            </div>
                        </div>

                        <div class="filter-group filter-group--range">
                            <label class="filter-label">Цена, р</label>
                            <div class="filter-range">
                                <input type="number" name="price_from" class="filter-input" id="priceFrom"
                                       value="{{ selected_price_from }}" placeholder="от" min="0" step="1000">
                                <span class="filter-range__divider">—</span>
                                <input type="number" name="price_to" class="filter-input" id="priceTo"
                                       value="{{ selected_price_to }}" placeholder="до" min="0" step="1000">
                            </div>
                        </div>

                        <div class="filter-group filter-group--range">
                            <label class="filter-label">Объем</label>
                            <div class="filter-range">
                                <input type="number" name="engine_volume_from" class="filter-input" id="engineVolumeFrom"
                                       value="{{ selected_engine_volume_from }}" placeholder="от" min="0" step="0.1">
                                <span class="filter-range__divider">—</span>
                                <input type="number" name="engine_volume_to" class="filter-input" id="engineVolumeTo"
                                       value="{{ selected_engine_volume_to }}" placeholder="до" min="0" step="0.1">
                            </div>
                        </div>

                        <div class="filter-group filter-group--range">
                            <label class="filter-label">Год</label>
                            <div class="filter-range">
                                <select name="year_from" class="filter-select" id="yearFromSelect">
                                    <option value="">от</option>
                                    {% for year in years %}
                                        <option value="{{ year }}" {% if selected_year_from == year|stringformat:"d" %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                                <span class="filter-range__divider">—</span>
                                <select name="year_to" class="filter-select" id="yearToSelect">
                                    <option value="">до</option>
                                    {% for year in years %}
                                        <option value="{{ year }}" {% if selected_year_to == year|stringformat:"d" %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="popular__filters-actions">
                        <button type="submit" class="btn btn--primary">Применить фильтры</button>
                    </div>
                </form>

                {% if sample %}
                    <span class="muted">Показаны примеры. Добавьте реальные авто через админку.</span>
                {% elif paginator %}
                    <span class="muted">Найдено: {{ paginator.count }}</span>
                {% else %}
                    <span class="muted">Найдено: {{ cars|length }}</span>
                {% endif %}
            </div>

            <div class="popular__cards">
                {% for car in cars %}
                    <article class="car-card">
                        <div class="car-card__img-wrap">
                            {% if car.get_image_url %}
                                <img src="{{ car.get_image_url }}" alt="{{ car.name }}" class="car-card__img">
                            {% else %}
                                <img src="{% static 'images/placeholder-car.jpg' %}" alt="{{ car.name }}" class="car-card__img">
                            {% endif %}
                        </div>
                        <div class="car-card__body">
                            <p class="car-card__pub">Номер публикации #{{ forloop.counter|add:1000 }}</p>
                            <h3 class="car-card__title">{{ car.manufacturer }} {{ car.model }}</h3>

                            <div class="car-card__row">
                                <div class="car-card__col">
                                    <span class="car-card__label">Кузов</span>
                                    <span class="car-card__value">{{ car.body_type|default:"-" }}</span>
                                </div>
                                <div class="car-card__col">
                                    <span class="car-card__label">Год выпуска</span>
                                    <span class="car-card__value">{{ car.year }}</span>
                                </div>
                            </div>

                            <div class="car-card__row">
                                <div class="car-card__col">
                                    <span class="car-card__label">Пробег</span>
                                    <span class="car-card__value">{{ car.mileage_km }} км</span>
                                </div>
                                <div class="car-card__col">
                                    <span class="car-card__label">Объем двигателя</span>
                                    <span class="car-card__value">{{ car.engine_volume|default:"-" }}</span>
                                </div>
                            </div>

                            <div class="car-card__divider"></div>

                            <div class="car-card__price-row">
                                <div>
                                    <span class="car-card__label">Стоимость:</span>
                                    <p class="car-card__price">{{ car.price|floatformat:0|intcomma }} ₽</p>
                                </div>

                                <a class="btn car-card__btn" href="{% url 'catalog:detail' car.id %}">
                                    Подробнее
                                </a>
                            </div>
                        </div>
                    </article>
                {% empty %}
                    <p class="muted">Пока нет доступных позиций.</p>
                {% endfor %}
            </div>

            {% if page_obj and paginator.num_pages > 1 %}
            <nav class="pagination" aria-label="Пагинация каталога">
                <div class="pagination__inner">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}" class="pagination__link pagination__link--prev">
                            &laquo; Назад
                        </a>
                    {% endif %}

                    <span class="pagination__info">
                        Страница {{ page_obj.number }} из {{ paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}" class="pagination__link pagination__link--next">
                            Вперёд &raquo;
                        </a>
                    {% endif %}
                </div>
            </nav>
            {% endif %}
        </div>
    </div>
</section>

<script>
  // Обработка фильтров и сортировки
  document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const filterToggleBtn = document.getElementById('filterToggleBtn');
    const manufacturerSelect = document.getElementById('manufacturerSelect');
    const modelSelect = document.getElementById('modelSelect');

    // Переключение видимости фильтров
    if (filterToggleBtn && filterForm) {
      filterToggleBtn.addEventListener('click', function() {
        const isExpanded = filterForm.classList.toggle('filter-form--expanded');
        filterToggleBtn.setAttribute('aria-expanded', isExpanded);
        filterToggleBtn.classList.toggle('filter-toggle-btn--active', isExpanded);
      });
    }

    // Вспомогательная функция для переключения выпадающих меню
    function toggleDropdown(button, menu, menuClass, buttonClass) {
      const isOpen = menu.classList.contains(menuClass);

      // Закрываем все открытые меню
      document.querySelectorAll(`.${menuClass}`).forEach(openMenu => {
        openMenu.classList.remove(menuClass);
      });
      document.querySelectorAll(`.${buttonClass}`).forEach(activeBtn => {
        activeBtn.classList.remove(buttonClass);
      });

      // Переключаем текущее меню
      menu.classList.toggle(menuClass, !isOpen);
      button.classList.toggle(buttonClass, !isOpen);
    }

    // Переключение выпадающего меню сортировки
    const sortToggleBtn = document.getElementById('sortToggleBtn');
    const sortDropdownMenu = document.getElementById('sortDropdownMenu');

    if (sortToggleBtn && sortDropdownMenu) {
      sortToggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleDropdown(sortToggleBtn, sortDropdownMenu, 'sort-dropdown-menu--open', 'sort-toggle-btn--active');
      });

      // Обработка кликов по опциям сортировки
      sortDropdownMenu.addEventListener('click', function(e) {
        if (e.target.classList.contains('sort-option') || e.target.closest('.sort-option')) {
          e.preventDefault();
          const option = e.target.classList.contains('sort-option') ? e.target : e.target.closest('.sort-option');
          const sortValue = option.dataset.sort;

          // Создаем URL с новым параметром сортировки
          const url = new URL(window.location);
          if (sortValue) {
            url.searchParams.set('sort', sortValue);
          } else {
            url.searchParams.delete('sort');
          }

          // Перенаправляем на новую страницу
          window.location.href = url.toString();
        }
      });
    }

    // При изменении марки сбрасываем модель
    if (manufacturerSelect && modelSelect) {
      manufacturerSelect.addEventListener('change', function() {
        modelSelect.value = '';
      });
    }

    // Обработка отправки формы
    if (filterForm) {
      filterForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Удаляем пустые поля из формы
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();

        formData.forEach((value, key) => {
          if (value && value.trim() !== '') {
            params.append(key, value);
          }
        });

        // Перенаправляем на новую страницу с фильтрами
        const newUrl = '{% url "catalog:list" %}' + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
      });
    }

    // Закрываем все меню при клике вне их
    document.addEventListener('click', function(e) {
      const openMenus = document.querySelectorAll('.sort-dropdown-menu--open');
      const activeButtons = document.querySelectorAll('.sort-toggle-btn--active');

      openMenus.forEach(menu => {
        const button = menu.previousElementSibling;
        if (!button.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.remove('sort-dropdown-menu--open');
          button.classList.remove('sort-toggle-btn--active');
        }
      });
    });
  });
</script>
{% endblock %}
